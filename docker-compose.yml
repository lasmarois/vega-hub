services:
  # Development: Run frontend and backend separately for hot reload
  frontend-dev:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./web:/app
      - frontend_node_modules:/app/node_modules
    ports:
      - "5173:5173"
    command: sh -c "npm install && npm run dev -- --host"
    profiles:
      - dev

  backend-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    volumes:
      - .:/app
      - go_modules:/go/pkg/mod
    ports:
      - "8080:8080"
    environment:
      - VEGA_HUB_DEV=true
      - VEGA_HUB_FRONTEND_URL=http://localhost:5173
    profiles:
      - dev

  # Build: Create production binary
  build:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./dist:/out
    command: sh -c "cp /app/vega-hub /out/vega-hub && chmod +x /out/vega-hub"
    profiles:
      - build

volumes:
  frontend_node_modules:
  go_modules:
